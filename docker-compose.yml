version: '3'
services:

#-------------------------#

  wazigate-system:
    build: ./wazigate-system
#    image: python:latest
    image: waziup/wazigate-system
    volumes:
      - ./wazigate-system:/app #Only for development
      - ./wazigate-system/conf.json:/app/conf.json
      - /var/run/dbus:/var/run/dbus
      - /etc/hostapd:/etc/hostapd
      - /sbin/shutdown:/sbin/shutdown
      - /sys/class/gpio:/sys/class/gpio
      - /dev/mem:/dev/mem
    ports:
      - "5000:5000"
    privileged: true
    network_mode:
      "host"
    environment:
      - FLASK_DEBUG=1 # for debug has to be set to 1
      - FLASK_PORT=5000
    command: sh -c "python /app/setup.py; python /app/api.py | python /app/start.py"
    restart: always

#-------------------------#

  wazigate-ui:
    build: ./wazigate-ui
#    image: php:7.2-apache
    image: waziup/wazigate-ui
    volumes:
      - ./wazigate-ui:/var/www/html
    ports:
      - "80:80"
    network_mode: "host"
    logging:
      driver: none
    depends_on:
      - wazigate-system
    restart: always

#-------------------------#
  
  waziup-edge:
    build: ./wazigate-edge
    image: waziup/wazigate-edge
    ports:
      - "880:880"
      - "1883:1883"
    environment:
      - HTTP_PORT=880
#    network_mode: host
    restart: always

#-------------------------#

  mongo:
    image: mongo:3.2.8
    hostname: mongo
    ports:
      - "27017:27017"
    volumes:
      - ./data/mongo:/data/db
    healthcheck:
      test: echo 'db.stats().ok' | mongo localhost:27017/local --quiet
      interval: 5s
      timeout: 5s
      retries: 12
    extra_hosts:
      - "localhost:127.0.0.1"

#-------------------------#

